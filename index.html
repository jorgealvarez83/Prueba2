<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kalmanjs@1.0.0/dist/kalman.min.js"></script>
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
      <a-image
        src="https://cdn.glitch.global/ce7134ba-aa63-4659-b6c6-708a1228887b/IMG_1628.png?v=1692699941840"
        width="3"
        height="3"
        gps-projected-entity-place="latitude: 6.2510278; longitude: -75.5600832;"
        position="0 2 -5"
        look-at="[gps-camera]"
      ></a-image>

      <a-text
        value="Yorsh logró Implementar AR con Geolocalización."
        look-at="[gps-camera]"
        scale="2 2 2"
        gps-projected-entity-place="latitude: 6.2510278; longitude: -75.5600832;"
        position="0 1.5 -3"
      ></a-text>

      <a-camera gps-camera rotation-reader> </a-camera>
    </a-scene>
    
    <script>
      // Crear una instancia del filtro de Kalman
      const kalmanFilter = new KalmanFilter({ R: 0.01, Q: 3 });

      // Obtener elementos de la escena
      const imageElement = document.querySelector('a-image');
      const textElement = document.querySelector('a-text');

      // Función para actualizar elementos de la escena con los datos filtrados
      function updateSceneElements(filteredData) {
        const filteredPosition = filteredData.position;

        // Actualizar la posición de la imagen y el texto usando la posición filtrada
        imageElement.setAttribute('gps-projected-entity-place', filteredPosition);
        textElement.setAttribute('gps-projected-entity-place', filteredPosition);
      }

      // Simulación de obtención de datos de GPS
      function getGPSData() {
        // Simular latitud y longitud del GPS
        const latitude = 6.2510278 + Math.random() * 0.001;
        const longitude = -75.5600832 + Math.random() * 0.001;
        return { latitude, longitude };
      }

      // Bucle de actualización continua
      function mainLoop() {
        // Obtener datos de GPS (latitud, longitud)
        const { latitude, longitude } = getGPSData();

        // Aplicar el filtro de Kalman a los datos de GPS
        const filteredData = kalmanFilter.filter({ latitude, longitude });

        // Actualizar los elementos de la escena con datos filtrados
        updateSceneElements(filteredData);

        // Repetir el bucle
        requestAnimationFrame(mainLoop);
      }

      // Iniciar el bucle principal
      mainLoop();
    </script>
  </body>
</html>
